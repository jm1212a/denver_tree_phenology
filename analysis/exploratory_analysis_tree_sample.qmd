---
title: "Exploratory Analysis"
author: "Jared Martin"
format: html
editor: visual
---

```{r}

library(tidyverse)
library(sf)
library(tigris)
library(gridExtra)
library(leaflet)

```

```{r}

denver_tree <- read_rds("../data_raw/denver_tree/tree_inventory_denver_20250911.rds")

glimpse(denver_tree)

```

```{r}

denver_county <- counties(state = "CO", cb = TRUE) %>%
  filter(NAME == "Denver") %>%
  st_transform(crs = 4326) # adjust to local projection for final sample

```

```{r}

denver_tree %>%
  # Fix formatting of common names: convert "last, first" to "first last"
  mutate(
    species_common = if_else(
      str_detect(species_common, ","),# check if a comma exists
      str_replace(species_common, "^(.*),\\s*(.*)$", "\\2 \\1"), # swap parts around
      species_common  # leave unchanged if no comma
    ),
    # Combine scientific and common names into one column
    botanic_common = paste(species_botanic, "(", species_common, ")"),
    # Standardize disease/pest field: anything containing "N/A" becomes exactly "N/A"
    disease_pest_def = if_else(str_detect(disease_pest_def, "N/A"), 
                               "N/A", disease_pest_def)
    ) %>%
  filter(species_botanic != "Tree requested") %>% # Remove rows with placeholder species
  # Extract the Genus + species (binomial name) from species_botanic
  mutate(
    species_sci = str_extract(species_botanic, "^[A-Za-z]+\\s+x?\\s?[A-Za-z]+")
  ) %>% 
  filter(!is.na(species_sci)) %>% # Keep only rows with a valid species_sci
  st_as_sf(
    wkt = "the_geom", # column with WKT strings
    crs = 4326        # EPSG:4326 (lon/lat in WGS84) adjust to local projection for final sample
    ) %>%
  st_filter(denver_county) %>%  # filtering out trees that are not with Denver County
  filter(x_long < -104.7302) %>% 
  left_join(read_csv2("../data_raw/dc_trees/dc_tree_species.csv"), 
            by = "species_sci") %>% # loading list of dc tree species
  mutate(dc_tree = case_when(
    is.na(dc_tree) ~ FALSE,  # changing na to false
    .default = dc_tree        
  )) -> denver_tree_sf
 
```

```{r}

## Classification created using AI according to the USDA/Forest Service disease classification. Spot checking done. Further checks will need to be done prior to publish.

denver_tree_sf %>% 
  group_by(disease_pest_def) %>% 
  filter(disease_pest_def != "N/A") %>% 
  summarise(n = n())  %>% 
  pull(disease_pest_def)

tree_disease_usda <- tibble(
  disease_pest_def = c(
    "adelgids", "anthracnose", "aphids", "armillaria", "ash bark beetle",
    "bacterial wetwood", "bagworms", "borers", "bullet gall", "cankers",
    "carpenter ants", "chlorosis", "construction damage", "crown dieback",
    "decay fungi", "drought stress", "dutch elm disease", "earwigs",
    "elm leaf beetle", "emerald ash borer", "eriophyid mites", "fire blight",
    "foliage disorder", "frass", "fruiting bodies", "gall insects", "gummosis",
    "heavy discoloration", "herbicide", "ips beetle", "japanese beetle",
    "kermes scale", "leaf necrosis", "leaf scorch", "lilac-ash borer",
    "mealybug", "mistletoe", "needle necrosis", "needlecast", "oak twig bore",
    "oak twig borer", "other - see notes", "pitch canker", "pitch moth",
    "pitch tube", "powdery mildew", "red-headed ash borer", "rust",
    "sapsucker damage", "scale insects", "signs of stress", "slime flux",
    "sooty mold", "spider mites", "squirrel damage", "sunscald",
    "termites", "thin canopy", "thousand cankers disease", "thrips damage",
    "thyronectria canker", "turpentine beetle", "tussock moth",
    "verticilium wilt", "witch's broom", "woodpecker damage"
  ),
  usda_disease_category = c(
    "Insects/Arthropods", "Fungal Diseases", "Insects/Arthropods", "Fungal Diseases",
    "Insects/Arthropods", "Bacterial Diseases", "Insects/Arthropods",
    "Insects/Arthropods", "Insects/Arthropods", "Fungal Diseases",
    "Insects/Arthropods", "Abiotic/Environmental Stress", "Animal/Mechanical Damage",
    "Abiotic/Environmental Stress", "Fungal Diseases", "Abiotic/Environmental Stress",
    "Fungal Diseases", "Insects/Arthropods", "Insects/Arthropods",
    "Insects/Arthropods", "Insects/Arthropods", "Bacterial Diseases",
    "Abiotic/Environmental Stress", "Insects/Arthropods", "Fungal Diseases",
    "Insects/Arthropods", "Abiotic/Environmental Stress", "Abiotic/Environmental Stress",
    "Abiotic/Environmental Stress", "Insects/Arthropods", "Insects/Arthropods",
    "Insects/Arthropods", "Abiotic/Environmental Stress", "Abiotic/Environmental Stress",
    "Insects/Arthropods", "Insects/Arthropods", "Insects/Arthropods",
    "Abiotic/Environmental Stress", "Fungal Diseases", "Insects/Arthropods",
    "Insects/Arthropods", "Other", "Fungal Diseases", "Insects/Arthropods",
    "Other", "Fungal Diseases", "Insects/Arthropods", "Fungal Diseases",
    "Animal/Mechanical Damage", "Insects/Arthropods", "Abiotic/Environmental Stress",
    "Fungal Diseases", "Fungal Diseases", "Insects/Arthropods", "Animal/Mechanical Damage",
    "Animal/Mechanical Damage", "Insects/Arthropods", "Abiotic/Environmental Stress",
    "Insects/Arthropods", "Insects/Arthropods", "Fungal Diseases", "Insects/Arthropods",
    "Insects/Arthropods", "Fungal Diseases", "Abiotic/Environmental Stress", "Animal/Mechanical Damage"
  )
)

tree_disease_usda

```


To-do List:

1.  Add filter to exclude the 30 trees near the Denver Airport.
2.  Add in the DC Scientific data using code on 52 to 56 to extract only genus and species from DC.
3.  Calculate the % of surfaces around each tree location.
4.  leaflet_satellite backdrop
5.  shinny app \_ filter tree sci_name

-   filter for cluster or points
-   filter size
-   variables selections (for distributions plots)
-   distribution plot (y %total / x lat or long) \* maybe 3d chart

```{r}

leaflet(denver_tree_sf) %>%
  addTiles()%>%
  addPolygons(
    data = denver_county,
    fillOpacity = 0,        # Transparent fill
    color = "red",          # Boundary color
    weight = 2,             # Line thickness
    opacity = 0.8           # Line opacity
  ) %>% 
  addCircleMarkers(
    radius = .1,
    color = "forestgreen",
    stroke = FALSE,
    fillOpacity = 0.1,
    clusterOptions = markerClusterOptions()
  )

```
