---
title: "cleaning_nooa_data"
format: html
editor: visual
---

```{r}

library(tidyverse)

```

```{r}

source("./helper_functions/read_and_clean.R")

```

```{r}

read_fwf("./raw_data_sets/ghcnd-stations.txt", 
         col_positions = fwf_widths(c(11, 10, 10, 10, 100))) %>% 
  rename(station_id = X1, latitude = X2, longitude = X3, elevation_state = X4, Name = X5) %>% 
  filter( station_id %in% c("USW00023062", "USC00052223")) %>% 
  mutate(elevation = str_extract(elevation_state, "-?\\d+")) %>% 
  mutate(state = str_extract(elevation_state, "[:upper:]+")) %>% 
  mutate(elevation = case_when(
    elevation == 999 | elevation == -999 ~ NA,  
    TRUE ~ elevation)) %>% 
  mutate(elevation = as.double(elevation)) %>%
  select(-elevation_state) %>% 
  right_join(read_and_clean("./raw_data_sets/USW00023062.dly"), 
             by = "station_id")%>% 
  mutate(year = year(date)) %>% 
  filter(year >= 2017 & year <= 2025 ) %>% 
  group_by(year, date, station_id) %>% 
  mutate(
    mean_temp = mean((TMAX + TMIN) / 2, na.rm = TRUE),
    month = month(date),
    day = day(date)) %>% 
  rename(tmax = TMAX,
         tmin = TMIN,
         prcp = PRCP,
         snow = SNOW,
         snwd = SNWD)-> climate_data

climate_data %>%
  filter((month %in% c(1, 2, 12))) %>%
  mutate(winter_year = ifelse(month == 12, year + 1, year)) %>%
  group_by(winter_year) %>%
  summarise(winter_prcp = sum(prcp, na.rm = TRUE), #months chosen 12,1,2
            winter_prcp_days = sum(prcp != 0, na.rm = TRUE),
            winter_temp = mean(mean_temp, na.rm = TRUE),
            winter_mean_tmax = mean(tmax, na.rm = TRUE))%>% 
  rename(year = winter_year)-> winter_metrics

climate_data %>%
  filter((month %in% c(2, 3))) %>% 
  group_by(year) %>%
  summarise(late_winter_prcp = sum(prcp, na.rm = TRUE), #months chosen 2,3
            late_winter_prcp_days = sum(prcp != 0, na.rm = TRUE),
            late_winter_temp = mean(mean_temp, na.rm = TRUE),
            late_winter_mean_tmax = mean(tmax, na.rm = TRUE)) -> late_winter_metrics

climate_data %>%
  filter((month %in% c(3, 4, 5))) %>% 
  group_by(year) %>%
  summarise(spring_prcp = sum(prcp, na.rm = TRUE), #months chosen 3,4
            spring_prcp_days = sum(prcp != 0, na.rm = TRUE),
            spring_temp = mean(mean_temp, na.rm = TRUE),
            spring_mean_tmax = mean(tmax, na.rm = TRUE)) -> spring_metrics

climate_data %>%
  filter((month %in% c(3, 4))) %>% 
  group_by(year) %>%
  summarise(early_spring_prcp = sum(prcp, na.rm = TRUE), #months chosen 3,4
            early_spring_prcp_days = sum(prcp != 0, na.rm = TRUE),
            early_spring_temp = mean(mean_temp, na.rm = TRUE),
            early_spring_mean_tmax = mean(tmax, na.rm = TRUE)) -> early_spring_metrics

climate_data %>%
  filter((month %in% c(5, 6))) %>% 
  group_by(year) %>%
  summarise(late_spring_prcp = sum(prcp, na.rm = TRUE), #months chosen 5,6
            late_spring_prcp_days = sum(prcp != 0, na.rm = TRUE),
            late_spring_temp = mean(mean_temp, na.rm = TRUE),
            late_spring_mean_tmax = mean(tmax, na.rm = TRUE)) -> late_spring_metrics

climate_data %>%
  filter((month %in% c(6, 7, 8))) %>% 
  group_by(year) %>%
  summarise(summer_prcp = sum(prcp, na.rm = TRUE), #months chosen 6,7,8
            summer_prcp_days = sum(prcp != 0, na.rm = TRUE),
            summer_temp = mean(mean_temp, na.rm = TRUE),
            summer_mean_tmax = mean(tmax, na.rm = TRUE)) -> summer_metrics

climate_data %>%
  filter((month %in% c(7, 8))) %>% 
  group_by(year) %>%
  summarise(late_summer_prcp = sum(prcp, na.rm = TRUE), #months chosen 8,9
            late_summer_prcp_days = sum(prcp != 0, na.rm = TRUE),
            late_summer_temp = mean(mean_temp, na.rm = TRUE),
            late_summer_mean_tmax = mean(tmax, na.rm = TRUE)) -> late_summer_metrics

climate_data %>%
  filter((month %in% c(9, 10, 11))) %>% 
  group_by(year) %>%
  summarise(fall_prcp = sum(prcp, na.rm = TRUE), #months chosen 9,10,11
            fall_prcp_days = sum(prcp != 0, na.rm = TRUE),
            fall_temp = mean(mean_temp, na.rm = TRUE),
            fall_mean_tmax = mean(tmax, na.rm = TRUE)) -> fall_metrics

climate_data %>%
  filter((month %in% c(9, 10))) %>% 
  group_by(year) %>%
  summarise(early_fall_prcp = sum(prcp, na.rm = TRUE), #months chosen 9,10
            early_fall_prcp_days = sum(prcp != 0, na.rm = TRUE),
            early_fall_temp = mean(mean_temp, na.rm = TRUE),
            early_fall_mean_tmax = mean(tmax, na.rm = TRUE)) -> early_fall_metrics

climate_data %>%
  filter((month %in% c(11, 12))) %>% 
  group_by(year) %>%
  summarise(late_fall_prcp = sum(prcp, na.rm = TRUE), # months chosen 11,12
            late_fall_prcp_days = sum(prcp != 0, na.rm = TRUE),
            late_fall_temp = mean(mean_temp, na.rm = TRUE),
            late_fall_mean_tmax = mean(tmax, na.rm = TRUE)) -> late_fall_metrics

climate_data %>%
  group_by(year) %>%
  summarise(later_winter_cumulative_prcp = sum(prcp[month %in% c(1, 2, 3)], 
                                               na.rm = TRUE),
            spring_prcp_cumulative_prcp = sum(prcp[month %in% c(1, 2, 3, 4 , 5)], 
                                                   na.rm = TRUE),
            early_spring_cumulative_prcp = sum(prcp[month %in% c(1, 2, 3, 4)], 
                                                    na.rm = TRUE),
            late_spring_cumulative_prcp = sum(prcp[month %in% c(1, 2, 3, 4, 5)], 
                                                   na.rm = TRUE),
            summer_cumulative_prcp = sum(prcp[month %in% c(1, 2, 3, 4, 5, 6, 7, 8)], 
                                                   na.rm = TRUE),
            late_summer_cumulative_prcp = sum(prcp[month %in% c(1, 2, 3, 4, 5, 6, 7, 8, 9)], 
                                                   na.rm = TRUE),
            early_fall_cumulative_prcp = sum(prcp[month %in% c(1, 2, 3, 4, 5, 6, 7, 8, 9,10)], 
                                                   na.rm = TRUE),
            fall_cumulative_prcp = sum(prcp[month %in% c(1, 2, 3, 4, 5, 6, 7, 8, 9,10,11)], 
                                                   na.rm = TRUE),
            late_fall_cumulative_prcp = sum(prcp[month %in% c(1, 2, 3, 4, 5, 6, 7, 8, 9,10,11,12)], 
                                                   na.rm = TRUE)) -> cumulative_prcp

list(winter_metrics, late_winter_metrics, spring_metrics, early_spring_metrics,
     late_spring_metrics,summer_metrics, late_summer_metrics, fall_metrics,
     early_fall_metrics, late_fall_metrics, cumulative_prcp) %>% 
  reduce(left_join, by = "year") %>% 
  write_csv("./climate_variables/climate_variables.csv")

```



