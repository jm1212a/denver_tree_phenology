---
title: "cleaning_nooa_data"
format: html
editor: visual
---

```{r}

library(tidyverse)

```

```{r}

source("./helper_functions/read_and_clean.R")

```

```{r}

#USC00052223 is in an area of high impervious surfaces on average has a higher degree temp. 
#Over the time of the study period USC00052223, the station in high impervious 
# surfaces has a statistical significant higher mean temperature, in 2 our of 
# the 7 years of the study 

bind_rows(read_and_clean("./raw_data_sets/USC00052223.dly"), read_and_clean("./raw_data_sets/USW00023062.dly")) %>% 
  group_by(year(date), station_id) %>% 
  mutate(year = year(date)) %>% 
  filter(year >= 2018 & year <= 2024 ) %>% 
  mutate(station_id = factor(station_id, levels = c("USC00052223", "USW00023062"))) %>% 
  group_by(year, date, station_id) %>% 
  summarise(
    mean_temp = mean((TMAX + TMIN) / 2, na.rm = TRUE),
    tmin = TMIN,
    tmax = TMAX,
    total_precip = sum(PRCP, na.rm = TRUE),
    .groups = "drop"
  ) %>% 
  group_by(year)%>%
  summarise(
    t_test = list(t.test(
      mean_temp ~ station_id,
      data = cur_data()
    ))
  ) %>%
  mutate(tidy_results = map(t_test, broom::tidy)) %>%
  unnest(tidy_results) %>%
  select(year, estimate1, estimate2, statistic, p.value, conf.low, conf.high) 

  

```


```{r}

read_fwf("./raw_data_sets/ghcnd-stations.txt", 
         col_positions = fwf_widths(c(11, 10, 10, 10, 100))) %>% 
  rename(station_id = X1, latitude = X2, longitude = X3, elevation_state = X4, Name = X5) %>% 
  filter( station_id %in% c("USW00023062", "USC00052223")) %>% 
  mutate(elevation = str_extract(elevation_state, "-?\\d+")) %>% 
  mutate(state = str_extract(elevation_state, "[:upper:]+")) %>% 
  mutate(elevation = case_when(
    elevation == 999 | elevation == -999 ~ NA,  
    TRUE ~ elevation)) %>% 
  mutate(elevation = as.double(elevation)) %>%
  select(-elevation_state) %>% 
  right_join(bind_rows(read_and_clean("./raw_data_sets/USC00052223.dly"),
                       read_and_clean("./raw_data_sets/USW00023062.dly")), 
             by = "station_id") %>% 
  mutate() 


```

```{r}

read.fwf("./raw_data_sets/USW00023062.dly",
                 widths = c(11, 4, 2, 4, rep(8, 31)), 
                 col.names = c("station_id", "year", "month", "element", 
                               paste0("day_", 1:31)),
                 stringsAsFactors = FALSE) %>% 
  tail(20)
  #mutate(across(starts_with("day_"),
  #              ~ as.numeric(str_extract(.x, "-?\\d+"))))

```

