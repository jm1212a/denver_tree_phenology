---
title: "Consolidating_raw_data"
format: html
editor: visual
---

```{r}

library(tidyverse)

```

# loading denver_tree_data

```{r}

st_drop_geometry(st_read("./denver_tree/denver_trees_sample.geojson")) %>% 
  mutate(UID = row_number()) %>% 
  left_join(read_rds("./landcover/cleaned_data/land_cover.rds"), 
            by = "UID") -> tree_ldc

read_rds("./ndvi/pheno_curve_metrics/extracted_metrics.rds") %>% 
  mutate(UID = as.integer(UID)) %>% 
  left_join(tree_ldc, by = "UID") %>% 
  group_by(flag) %>% 
  mutate(year = as.double(str_replace(flag, "_\\d+$",""))) %>% 
  left_join(
    read_csv("./nooa_daily_weather_obs/climate_variables/climate_variables.csv"), 
    by = "year") -> tree_ldc_metrics_climate

tree_ldc_metrics_climate %>%
  group_by(UID, year) %>% 
  summarize(n = n()) %>% 
  filter(n > 1) %>% 
  ungroup()-> multi_cylce

anti_join(tree_ldc_metrics_climate, multi_cylce, 
          by = c("UID", "year")) %>%
  ungroup() %>% 
  select(-flag)%>% 
  select(8, species_botanic, species_common, leaf_persistence, botanic_common, 
         x_long, y_lat, year, usda_disease_category, 9:10, DER.sos_doy:DER.eos_doy, 
         Greenup_doy:Dormancy_doy, DER.sos_date:DER.eos_date, 
         Greenup_date:Dormancy_date,  winter_prcp:late_fall_temp, 
         unirrigated:water) %>% 
  write_rds("../data/processed_trees_ndvi_lc_climate.rds")

```


