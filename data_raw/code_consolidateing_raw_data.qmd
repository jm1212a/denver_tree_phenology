---
title: "Consolidating_raw_data"
format: html
editor: visual
---

```{r}

library(tidyverse)
library(phenofit)
library(sf)
library(patchwork)

```

# loading denver_tree_data

```{r}

st_drop_geometry(st_read("./denver_tree/denver_trees_sample.geojson")) %>% 
  mutate(UID = row_number()) %>% 
  left_join(read_rds("./landcover/cleaned_data/land_cover.rds"), 
            by = "UID") -> tree_ldc

read_rds("./ndvi/pheno_curve_metrics/extracted_metrics.rds") %>% 
  mutate(UID = as.integer(UID)) %>% 
  left_join(tree_ldc, by = "UID") %>% 
  rename(year = flag) %>% 
  mutate(year = as.double(str_replace(year, "_\\d+$",""))) %>% 
  left_join(read_csv("./nooa_daily_weather_obs/climate_variables/climate_variables.csv"), by = "year") -> tree_ldc_metrics_climate

```

```{r}

tree_ldc_metrics %>%
  group_by(species_common, leaf_persistence) %>%
  summarize(n = length(unique(UID))) 

```


```{r}

tree_ldc_metrics_climate %>% 
  filter(year < 2024,
         species_common == "Eastern Cottonwood") %>% 
  ggplot(aes(x = early_spring_prcp, y = DER.sos_doy))+
  geom_point()

names(tree_ldc_metrics_climate)

```


```{r}

tree_ldc_metrics_climate %>% 
  select(DER.sos_doy, late_winter_prcp_days, late_winter_temp, 
         winter_temp, winter_prcp_days) %>% 
  cor(use = "complete.obs") %>% 
  as.data.frame() %>% 
  select(DER.sos_doy) %>%  # Keep only DER.sos_doy column
  filter(row.names(.) != "DER.sos_doy")

```

```{r}

tree_ldc_metrics_climate %>% 
  select(DER.sos_doy, late_winter_prcp_days, late_winter_temp, 
         winter_temp, winter_prcp_days) %>% 
  cor(use = "pairwise.complete.obs") 

```
# Corrilation Matrixs by species 

```{r}

pheno_vars <- c("DER.sos_doy", "DER.eos_doy", "DER.pos_doy") 

sos_climate <- c("late_winter_prcp_days", "late_winter_temp", "late_winter_prcp", 
                 "winter_temp", "winter_prcp", "winter_prcp_days", 
                 "early_spring_temp", "early_spring_prcp_days", "early_spring_prcp",
                 "spring_prcp_days", "spring_temp", "spring_prcp")

eos_climate <- c("summer_temp", "summer_prcp", "summer_prcp_days","late_summer_prcp", 
                 "late_summer_prcp_days", "late_summer_temp", "fall_temp", 
                 "fall_prcp", "fall_prcp_days", "early_fall_prcp", 
                 "early_fall_prcp_days", "early_fall_temp",
                 "late_fall_prcp", "late_fall_prcp_days", "late_fall_temp")

pos_climate <- c("late_spring_temp", "late_spring_prcp", "late_spring_prcp_days") 

all_climate_vars <- unique(c(sos_climate, eos_climate, pos_climate))

calc_species_cor <- function(species_name, data){
  data %>% 
    filter(year < 2024, species_common == species_name) %>% 
    select(all_of(c(pheno_vars, all_climate_vars))) %>% 
    cor(use = "pairwise.complete.obs") %>% 
    as.data.frame() %>% 
    rownames_to_column("pheno_var") %>% 
    filter(pheno_var %in% pheno_vars) %>% 
    select(pheno_var, all_of(all_climate_vars)) %>% 
    pivot_longer(-pheno_var, names_to = "climate_var", values_to = "correlation") %>% 
    filter(
      (pheno_var == "DER.sos_doy" & climate_var %in% sos_climate) |
      (pheno_var == "DER.eos_doy" & climate_var %in% eos_climate) |
      (pheno_var == "DER.pos_doy" & climate_var %in% pos_climate)
    ) %>% 
    rename(!!species_name := correlation)
}

species_list <- c("Eastern Cottonwood", "American Elm", "Common Hackberry",
                  "Green Ash", "Honey Locust", "Plains Cottonwood", 
                  "Siberian Elm", "Silver Maple", "Tree of heaven")

# Calculate for all species
map(species_list, ~calc_species_cor(.x, tree_ldc_metrics_climate)) %>% 
  compact() %>%  # Remove NULL values
  reduce(full_join, by = c("pheno_var", "climate_var")) -> all_cors 

all_cors %>% 
  pivot_longer(cols = -c(pheno_var, climate_var), 
               names_to = "species", 
               values_to = "correlation") %>% 
  mutate(group = "Individual Species") %>% 
  bind_rows(
    all_cors %>% 
      pivot_longer(cols = -c(pheno_var, climate_var), 
                   names_to = "species", 
                   values_to = "correlation") %>% 
      group_by(pheno_var, climate_var) %>% 
      summarise(correlation = mean(correlation, na.rm = TRUE), .groups = "drop") %>% 
      mutate(species = "Average", group = "Average")
  ) %>% 
  
  ggplot(aes(x = species, y = climate_var, fill = correlation)) +
  geom_tile(color = "white", linewidth = 0.5) +
  geom_text(aes(label = sprintf("%.2f", correlation)), size = 2) +
  scale_fill_gradient2(low = "red", mid = "white", high = "darkgreen",
                       midpoint = 0, limits = c(-1, 1), 
                       name = "Correlation") +
  facet_grid(pheno_var ~ group, scales = "free", space = "free") +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1, size = 8),
    axis.text.y = element_text(size = 7),
    axis.title = element_blank(),
    strip.text = element_text(face = "bold")
  ) +
  labs(title = "Phenology-Climate Correlations Across Species")

```

