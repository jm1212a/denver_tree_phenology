---
title: "fitting and extracting phenological metrics"
format: html
editor: visual
---

```{r}

library(tidyverse)
library(phenofit)
library(oce)
library(zoo)

```

```{r}

read_rds("./raw_extracts/extracted_ndvi_value.rds") -> extracts

```

# Phenological Curve Tuning

```{r}

source("../../R/evaluate_pheno_methods.R")

pheno_curves <- c("AG", "Beck", "Elmore", "Zhang") 
season_curves <- c("wHANTS", "wSG", "wWHIT") 


evaluate_pheno_methods(
  extracts = extracts, 
  n_samples = 10,
  pheno_curves = pheno_curves,
  season_curves = season_curves, 
  min_observations = 6, 
  min_r2 = 0.9 ) 

```


# LOOP for All Trees

```{r, warning=FALSE}

extracts %>% 
  group_by(UID) %>% 
  summarise(n = n()) %>% 
  sample_n(100) %>% 
  pull(UID) -> trees

pheno_metrix_date <- data.frame()
pheno_metrix_doy <- data.frame()
fit_stats <- data.frame()

for (i in trees) {
  
  tryCatch({
    
    extracts %>% 
      filter(UID == i) %>% 
      mutate(ndvi = despike(ndvi, "median", n = 3, k = 5)) %>%
      mutate(
        time_numeric = as.numeric(im_date),
        trend = predict(lm(ndvi ~ time_numeric)),
        ndvi_detrended = ndvi - trend + mean(ndvi, na.rm = TRUE)
      ) -> extracts_samp
    
    check_input(
      t = extracts_samp$im_date,
      y = extracts_samp$ndvi, 
      south = FALSE
    ) -> test_input
    
    check_input(
      t = extracts_samp$im_date, 
      y = extracts_samp$ndvi_detrended,
      south = FALSE
    ) -> x_detrended 
    
    season_mov(
      x_detrended,
      options = list(
        rFUN = "smooth_wHANTS"
      )
    ) -> brks_mov 
    
    curvefits(test_input, brks_mov) -> fit
    
    get_GOF(fit) -> stats
    get_pheno(fit, "Elmore") -> metrics
    
    # Extract date and doy metrics
    metrics$date$Elmore %>% 
      mutate(UID = i) -> metrics_date
    
    metrics$doy$Elmore %>% 
      mutate(UID = i) -> metrics_doy
    
    data.frame(
      flag = names(fit),
      fit_data = I(fit))-> fit_lookup
    
    stats %>% 
      mutate(UID = i) %>% 
      left_join(fit_lookup, by = "flag") -> stats 
    
    # Bind rows
    bind_rows(pheno_metrix_date, metrics_date) -> pheno_metrix_date
    
    bind_rows(pheno_metrix_doy, metrics_doy) -> pheno_metrix_doy 
    
    bind_rows(fit_stats, stats) -> fit_stats
    
  }, error = function(e) {
    message(paste("Skipping tree", i, "- Error:", e$message))
  })
  
}

left_join(
  pheno_metrix_doy, 
  pheno_metrix_date, 
  by = c("UID", "flag", "origin"),
  suffix = c("_doy", "_date")) -> phen_metrix 

fit_stats %>% 
  filter(meth == "Elmore") %>% 
  right_join(phen_metrix) -> phen_metrix 

phen_metrix %>% 
  group_by(UID) %>% 
  summarise(mean_r2 = mean(R2, na.rm = TRUE),
            n = n()) %>% 
  filter(n >= 6 & mean_r2 >= .9) %>% 
  pull(UID) -> sample

phen_metrix %>% 
  filter(UID %in% sample) -> phen_metrix
  

```
```{r}

write_rds(phen_metrix, "extracted_metrics.rds")

```

# Graphing Each Curve

```{r}

source("../../R/plot_year.R")

plot_year(phen_metrix, "2020_1", "15598", 
          metrics = c("Inflection"))


```



